<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Variable Gain Amplifier - Arterial BP Triggering</title>
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script>

  <style>
    body {font-size: 90%;}
    pre, code {font-size: 100%;}
    h3, h4, h5, h6 {color: #2980b9; font-weight: 300}
  </style> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Arterial BP Triggering</a>
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
      <ul class="current">
    
        
        <span>Instructions</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../instructions/user_manual">User Manual</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../instructions/guidelines-for-adapting-to-new-instrument">Guidelines for using a Different Pressure Measurement System</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../instructions/reflash-the-microcontroller">Reflashing the Microcontroller</a>
                    
                </li>
            
        

    
        
        <span>System Design</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../apb-triggering">System Block Diagram</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../apb-triggering">Triggering Algorithm</a>
                    
                </li>
            
                <li class="toctree-l1 current">
                    <a class="current" href=".">Variable Gain Amplifier</a>
                    
                        <ul>
                        
                            <li class="toctree-l2"><a href="#variable-gain-amplifier-with-spi-interface">Variable Gain Amplifier with SPI Interface</a></li>
                            
                        
                            <li class="toctree-l2"><a href="#algorithm-for-gain-adjustment-on-the-fly">Algorithm for Gain Adjustment on the Fly</a></li>
                            
                        
                        </ul>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../gui-design">Monitoring Tool</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../pcb-design">PCB</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../testing-australian-data">Validation</a>
                    
                </li>
            
        

    
</ul>

      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="../.."></a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    <li>Variable Gain Amplifier</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="https://github.com/JoshBradshaw/Arterial-BP-MRI-Triggering-Unit" class="icon icon-github"> Edit on GitHub</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              <h2 id="variable-gain-amplifier-with-spi-interface">Variable Gain Amplifier with SPI Interface</h2>
<p>The analog output signal provided by the Samba Sensor’s pressure measurement system had a very small amplitude compared to the full scale range of the analog to digital converter, so an amplifier was required to increase the signal closer to the full scale range of the ADC. </p>
<p>Unfortunately, the blood pressure of fetal pigs has never been measured from the carotid artery, so it was impossible to determine the correct gain value for the amplifier in advance. This problem was further confounded, because the effect of our chosen anaesthetic on fetal blood pressure was also unknown. To deal with this problem, I opted to build a variable gain amplifier, with an automatic feedback system to maintain a consistent signal amplitude throughout the experiment. A simplified schematic variable gain amplifier circuit is shown below.</p>
<p><img alt="alt text" src="../..//images/simplified_schematic.png" title="Simplified schematic" /></p>
<p>This circuit uses a precision operational amplifier, with a digital potentiometer (AD5206) in the feedback path to allow the gain to be adjusted by the microcontroller as required. The digital potentiometer has 256 counts, giving the amplifier an adjustable gain range of 1-11x. This is sufficient for even the lowest possible fetal blood pressures.</p>
<h2 id="algorithm-for-gain-adjustment-on-the-fly">Algorithm for Gain Adjustment on the Fly</h2>
<p>The input of the gain adjustment is a sample from the ADC taken every 100ms. While each sample is recorded, the algorithm compares it to the minimum signal magnitude and maximum magnitude threshold which are 1/5 and 4/5 of the ADC’s full scale range, respectively. After a five second windowing period, the signal amplitude is compared against the thresholds, to see if any gain adjustment is required. The three possible cases:</p>
<ol>
<li>Signal failed to exceed minimum magnitude threshold during the five second window.</li>
<li>Signal exceeded maximum the maximum magnitude threshold during the five second window.</li>
<li>The signal exceeded the minimum magnitude threshold, and did not exceed the maximum threshold.
    In case one, the gain adjustment algorithm gradually increases the gain during each windowing period, as shown in the figure below. The gain increase stops when the signal exceeds the threshold. Same process occurs in reverse for case three. The algorithm is illustrated in the flow chart below.</li>
</ol>
<p><img alt="alt text" src="../..//images/gain-adjustment-algorithm.png" title="Gain adjustment algorithm flow chart" /></p>
<p>The actual functioning of the gain adjustment algorithm is illustrated in the plot below. In this test, the triggering system was connected to a function generator which produced a blood pressure waveform with a peak to peak voltage of 700mV. This signal amplitude is based upon recordings on fetal lambs with an identical transducer. As you can see, the gain is very gradually increased in such a manner that it does not disrupt the triggering algorithm, which operates perfectly throughout the duration of the gain increase.</p>
<p><img alt="alt text" src="../..//images/gain-adjustment-demo.png" title="Gain adjustment demo plot" /></p>

            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../gui-design" class="btn btn-neutral float-right" title="Monitoring Tool"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../apb-triggering" class="btn btn-neutral" title="Triggering Algorithm"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
    <!-- Copyright etc -->
    </p>
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
        
            <a class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
        
      <span><a href="../apb-triggering" style="color: #fcfcfc;">&laquo; Previous</a></span>
      <span style="margin-left: 15px"><a href="../gui-design" style="color: #fcfcfc">Next &raquo;</a></span>
    </span>
</div>
</body>
</html>