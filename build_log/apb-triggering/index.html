<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Triggering Algorithm - Arterial BP Triggering</title>
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script>

  <style>
    body {font-size: 90%;}
    pre, code {font-size: 100%;}
    h3, h4, h5, h6 {color: #2980b9; font-weight: 300}
  </style> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../instructions/user_manual" class="icon icon-home"> Arterial BP Triggering</a>
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
      <ul class="current">
    
        
        <span>Instructions</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../instructions/user_manual">User Manual</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../instructions/guidelines-for-adapting-to-new-instrument">Guidelines for using a Different Pressure Measurement System</a>
                    
                </li>
            
        

    
        
        <span>Build Log</span>
            
                <li class="toctree-l1 current">
                    <a class="current" href=".">Triggering Algorithm</a>
                    
                        <ul>
                        
                            <li class="toctree-l2"><a href="#arterial-blood-pressure-pulse-filtering-and-peak-detection">Arterial Blood Pressure Pulse Filtering and Peak Detection</a></li>
                            
                                <li><a class="toctree-l3" href="#algorithm-requirements">Algorithm Requirements:</a></li>
                            
                                <li><a class="toctree-l3" href="#filtering">Filtering</a></li>
                            
                                <li><a class="toctree-l3" href="#peak-detection">Peak Detection</a></li>
                            
                        
                            <li class="toctree-l2"><a href="#testing">Testing</a></li>
                            
                        
                        </ul>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../set-adaptive-gain-algorithm">Gain Adjustment Algorithm</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../adaptive-gain-adjustment">Variable Gain Amplifier</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../gui-design">Monitoring Tool</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../pcb-design">PCB</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../testing-australian-data">Validation</a>
                    
                </li>
            
        

    
</ul>

      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="../../instructions/user_manual"></a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../instructions/user_manual">Docs</a> &raquo;</li>
    <li>Triggering Algorithm</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="https://github.com/JoshBradshaw/Arterial-BP-MRI-Triggering-Unit" class="icon icon-github"> Edit on GitHub</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              <h2 id="arterial-blood-pressure-pulse-filtering-and-peak-detection">Arterial Blood Pressure Pulse Filtering and Peak Detection</h2>
<p>This post describes the algorithm used to detect the peaks of the arterial blood pressure pulses for triggering. The input to this algorithm is the sensor value of the blood pressure catheter, which is read by the analog to digital converter at a sampling rate of 250Hz. The output of this algorithm is a TTL pulse function, which triggers the MRI machine every time a unique heartbeat is detected.</p>
<h3 id="algorithm-requirements">Algorithm Requirements:</h3>
<p>The algorithm must:</p>
<ol>
<li>Be able to detect the pressure peaks using &lt;40ms of delay.</li>
<li>Correct DC drift in the same order of magnitude as the signal itself (past recordings with our instruments large DC drift).</li>
<li>Filter out high frequency noise.</li>
<li>Must perform optimally at a sampling rate between 200Hz to 500Hz.</li>
<li>Must work for pulse rates between 40 BPM to 300 BPM (a very reasonable range for humans and pigs, too low for use in mice).</li>
</ol>
<h3 id="filtering">Filtering</h3>
<p>Below is an image of an idealized arterial blood pressure pulse:</p>
<p><img alt="alt text" src="../..//images/ideal_arterial_blood_pressure_pulse.gif" title="An arterial blood pressure pulse" /></p>
<p>As you can see, there's a large pulse followed by a small reflection pulse just after the dichrontic notch. For the purposes of MRI triggering, the second pulse is not useful information. </p>
<p>To remove the second peak and establish a consistent baseline, I applied slope sum funtion <abbr>SSF</abbr> from the <i> An open-source algorithm to detect onset of arterial blood pressure pulses </i> by Zong et al.</p>
<p>The slope sum function is:</p>
<p><img alt="alt text" src="../..//images/slope_sum_function.png" title="the slope sum function" /></p>
<p>Here's an example blood pressure recording (in blue) and the corresponding slope sum function output (in red):</p>
<p><img src='/images/ssf_demo.png' alt="Slope Sum funciton applied to blood pressure waveform" style="width: 600px;"/></p>
<p>This simple function is extremely useful for two reasons:</p>
<ol>
<li>It reduces the second peak of the waveform to a negligible amplitude.</li>
<li>It's based only on slope, not absolute magnitudes, so it establishes a consistent baseline in the data, removing any DC drift.</li>
</ol>
<h3 id="peak-detection">Peak Detection</h3>
<p>A variety of peak detection algorithms were tested for this purpose. The best performing algorithm is a simple state machine with the following states:</p>
<ol>
<li>RISING</li>
<li>PEAK DETECTED</li>
<li>REFRACTORY</li>
</ol>
<p>The state machine works by advancing two moving averages as samples are collected. Each average is based on three samples, and they are spaced 3 samples apart (for a sampling rate of 250 Hz, this makes a gives a total delay of 9 x 4ms = 36ms). </p>
<h4 id="rising-state">RISING STATE</h4>
<p>When the state-machine is in rising state, it is constantly checking whether the right moving average has become greater than the left moving average. This is functionally equivalent to taking the backwards approximation of the derivative, but using averages instead of single points helps to ensure that little blips in the data won't be mistaken for the true peaks.</p>
<h4 id="peak-detected">PEAK DETECTED</h4>
<p>The state-machine sends a 3.3V TTL signal the to MRI scanner. For Siemens scanners the TTL signal is required to meet these criteria:</p>
<p><img alt="alt text" src="../..//images/siemens_external_trigger.png" title="the slope sum function applied to a human arterial blood pressure waveform" /></p>
<h4 id="refractory-period">REFRACTORY PERIOD</h4>
<p>The algorithm stays in the refractory state until all of the following conditions have been met:</p>
<ol>
<li>More than 170ms have passed since the last detected peak (based on a 300 BPM maximum heart rate)</li>
<li>The signal has surpassed the magnitude threshold. The magnitude threshold is computed as one quarter of the magnitude of the last three detected peaks.</li>
<li>The right moving average is greater than the left moving average, indicating that the blood pressure is rising.</li>
</ol>
<p>Once all of the above criteria are met, the state-machine reverts to RISING state and the cycle repeats.</p>
<h2 id="testing">Testing</h2>
<p>The algorithm was evaluated against the following test blood pressure waveforms.</p>
<ol>
<li><a href="http://physionet.cps.unizar.es/physiobank/database/slpdb/slpdb.shtml">MIT Database of non-invasive blood pressure recordings</a></li>
<li>Pulse oximeter of my own heart, taken while serving as test subject for a maternal health sequence.</li>
<li>Invasive fetal lamb blood pressure recordings, taken by an Australian research group.</li>
</ol>

            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../set-adaptive-gain-algorithm" class="btn btn-neutral float-right" title="Gain Adjustment Algorithm"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../.." class="btn btn-neutral" title="System Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
    <!-- Copyright etc -->
    </p>
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
        
            <a class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
        
      <span><a href="../.." style="color: #fcfcfc;">&laquo; Previous</a></span>
      <span style="margin-left: 15px"><a href="../set-adaptive-gain-algorithm" style="color: #fcfcfc">Next &raquo;</a></span>
    </span>
</div>
</body>
</html>